CREATE DATABASE QL_MYPHAM1
GO
USE QL_MYPHAM1
GO


CREATE TABLE LOAIMP
(
	MALOAI NCHAR(10) NOT NULL,
	TENLOAI NVARCHAR(50),
	CONSTRAINT PK_LOAIMP PRIMARY KEY (MALOAI)
)
CREATE TABLE MYPHAM
(
	MAMP NCHAR(10) NOT NULL,
	TENMP NVARCHAR(100),
	ANH VARCHAR(30),
	NGAYSX VARCHAR(30),
	TGBH VARCHAR(30),
	MALOAI NCHAR(10) NOT NULL,
	NSX NVARCHAR(50),
	DVT NVARCHAR(30),
	GIA int,
	CONSTRAINT PK_MYPHAM PRIMARY KEY (MAMP),
	CONSTRAINT FK_MYPHAM_LOAIMP FOREIGN KEY (MALOAI) REFERENCES LOAIMP(MALOAI)
)
CREATE TABLE KHACHHANG
(
	MAKH NCHAR(10) NOT NULL,
	TENKH NVARCHAR(50),
	DCHI NVARCHAR(50),
	DTHOAI NVARCHAR(20),
	CONSTRAINT PK_KHACHHANG PRIMARY KEY (MAKH)
)
CREATE TABLE HOADON
(
	MAHD NCHAR(10) NOT NULL,
	NGAYHD VARCHAR(30),
	MAKH NCHAR(10),
	TRIGIA int,
	CONSTRAINT PK_HOADON PRIMARY KEY (MAHD),
	CONSTRAINT FK_HOADON_KHACHHANG FOREIGN KEY (MAKH) REFERENCES KHACHHANG(MAKH)
)
CREATE TABLE CHITIETHD
(
	MAHD NCHAR(10) NOT NULL,
	MAMP NCHAR(10) NOT NULL,
	SOLUONG INT,
	DONGIA int,
	THANHTIEN int,
	CONSTRAINT PK_CHITIETHD PRIMARY KEY (MAHD,MAMP),
	CONSTRAINT FK_CHITIETHD_HOADON FOREIGN KEY (MAHD) REFERENCES HOADON(MAHD),
	CONSTRAINT FK_CHITIETHD_MYPHAM FOREIGN KEY (MAMP) REFERENCES MYPHAM(MAMP)
)
CREATE TABLE TaiKhoan 
(
	VAITRO char(10),
    EMAIL nvarchar(100) Unique,
	HOTEN nvarchar(60),
	NGAYSINH date,
	GIOITINH nchar(3),
	SDT varchar(11),
	TENDN varchar(20) Primary key,
	MATKHAU varchar(100),
	DIACHI NVARCHAR(50),
	ANHBIAUSER nvarchar(255)
)
CREATE TABLE GioHang
(
	TENDN varchar(20),
	MAMP NCHAR(10) NOT NULL,
	TENMP NVARCHAR(100),
	Anh nvarchar(255),
	Gia float,
	SoLuong int,
	ThanhTien float,
	constraint PK_GioHang primary key(TENDN,MAMP),
	constraint FK_GioHang_TenDN foreign key (TENDN) references TaiKhoan(TENDN),
	constraint FK_GioHang_MaSanPham foreign key (MAMP) references MYPHAM(MAMP)
)

set dateformat dmy
insert into TaiKhoan 
values	
('Admin',N'admin123@gmail.com',N'Đồ án','20/10/2003',N'Nam','0964020087','Admin','admin123',N'106 Tây Thạnh Tân Phú TP.HCM',''),
('User',N'khachhang1@gmail.com',N'Thanh Tú','10/10/2003',N'Nam','0902223337','thanhtu','123',N'62 Nguyễn Thị Tú Tân Phú TP.HCM',''),
('User',N'khachhang2@gmail.com',N'Nhật Tân','26/07/2003',N'Nam','037654321','nhattan','123',N'92 Lê Trọng Tấn Tân Phú TP.HCM',''),
('User',N'khachhang3@gmail.com',N'Hùng Hưng','3/12/2003',N'Nam','037886953','hunghung','123',N'69 Bình Hưng Hòa Bình Tân TP.HCM','')

select * from TaiKhoan
select * from GioHang
/*
--RBTV 1.
ALTER TABLE CHITIETHD
ADD CONSTRAINT CHK_SOLUONG CHECK (SOLUONG>0)

ALTER TABLE CHITIETHD
ADD CONSTRAINT CHK_DONGIA CHECK (DONGIA>0)

ALTER TABLE HOADON
ADD CONSTRAINT CHK_TRIGIA CHECK (TRIGIA>0)

ALTER TABLE MYPHAM
ADD CONSTRAINT CHK_TGBH CHECK (TGBH>=0)

--RBTV 2.
ALTER TABLE MYPHAM
ADD CONSTRAINT UNI_TENMP UNIQUE (TENMP)

ALTER TABLE LOAIMP
ADD CONSTRAINT UNI_TENLOAI UNIQUE (TENLOAI)

--RBTV 3.
ALTER TABLE KHACHHANG
ADD CONSTRAINT DF_DCHI DEFAULT 'KHONG XAC DINH' FOR DCHI

ALTER TABLE MYPHAM
ADD CONSTRAINT DF_TGBH DEFAULT 12 FOR TGBH
*/

/*
GO
--RBTV 4
CREATE TRIGGER KTRA_NGAYSX ON MYPHAM
FOR INSERT
AS
	IF (SELECT DAY(NSX) FROM inserted) <= DAY(GETDATE())
		COMMIT TRAN
	ELSE
		BEGIN
			PRINT 'NGAY SX KHONG HOP LE'
			ROLLBACK TRAN
		END
*/
INSERT INTO LOAIMP
VALUES  
('CLEAN_A',N'Tẩy trang & làm sạch'),
('CLEAN_B',N'Mặt nạ & Tẩy tế bào'),
('SERUM_A',N'Nước cân bằng'),
('SERUM_B',N'Nước dưỡng chất'),
('CREAM_A',N'Kem dưỡng da'),
('CREAM_B',N'Kem dưỡng mắt'),
('CREAM_C',N'Kem chống nắng'),
('PERFUME',N'Nước hoa'),
('MAKEUP',N'Trang điểm'),
('ABSOLUE',N'Tinh chất');


INSERT INTO MYPHAM(MAMP,TENMP,ANH,NGAYSX,TGBH,MALOAI,NSX,DVT,GIA)
VALUES 
('CLEAN001',N'SỮA RỬA MẶT TẠO BỌT CLARIFIQUE','cl001.jpg','01/01/2014','02','CLEAN_A','Lacome',N'Tuýp',1199000),
('CLEAN002',N'SỮA TẨY TRANG DOUCEUR GALATESIS','cl002.jpg','04/02/2003','02','CLEAN_A','Lacome',N'Tuýp',1299000),
('CLEAN003',N'BỘ SẢN PHẨM DƯỠNG ẨM HYDRAZEN','cl003.jpg','02/04/2014','06','CLEAN_A','Lacome',N'Bộ',1399000),
('CLEAN004',N'NƯỚC TẨY TRANG CHO VÙNG DA MẮT BI-FACIL','cl004.jpg','05/04/2003','03','CLEAN_A','Lacome',N'Chai',1499000),
('CLEAN005',N'SỮA RỬA MẶT LÀM SÁNG DA DẠNG GEL ABSOLUE','cl005.jpg','07/02/2016','02','CLEAN_A','Lacome',N'Tuýp',1599000),
('CLEAN006',N'BỘ DƯỠNG LÀM SẠCH & CÂN BẰNG DA DOUCER 400ML','cl006.jpg','08/12/2003','06','CLEAN_A','Lacome',N'Bộ',1699000),
('CLEAN011',N'MẶT NẠ DƯỠNG VÙNG MẮT TƯƠI TRẺ ADVANCED GENSIFIQUE','cl011.jpg','04/12/2003','01','CLEAN_B','Lacome',N'Miếng',1119000),
('CLEAN012',N'MẶT NẠ VÀNG ABSOLUE TÁI TẠO VÀ LÀM SÁNG DA','cl012.jpg','03/03/2016','01','CLEAN_B','Lacome',N'Miếng',1129000),
('CLEAN013',N'NƯỚC TẨY TRANG CHO VÙNG DA MẮT BI-FACIL','cl013.jpg','14/04/2003','03','CLEAN_B','Lacome',N'Chai',1139000),

('SERUM001',N'"NƯỚC THẦN" KÉP CLARIFIQUE','sr001.jpg','11/05/2003','03','SERUM_A','Lacome',N'Chai',1199000),
('SERUM002',N'"NƯỚC HOA HỒNG TONIQUE DOUCEUR','sr002.jpg','17/03/2003','03','SERUM_A','Lacome',N'Chai',1299000),
('SERUM003',N'"NƯỚC CÂN BẰNG DƯỠNG DA RÉNERGIE MULTI-LIFT','sr003.jpg','22/07/2003','03','SERUM_A','Lacome',N'Chai',1399000),
('SERUM004',N'"NƯỚC CÂN BẰNG CHIẾT XUẤT HOA HỒNG ABSOLUE ROSE 80','sr004.jpg','25/08/2003','03','SERUM_A','Lacome',N'Chai',1499000),
('SERUM005',N'"NƯỚC CÂN BẰNG DA DẠNG XỊT ABSOLUE L EXTRAIT ULTIMATE','sr005.jpg','16/09/2003','03','SERUM_A','Lacome',N'Chai',1599000),
('SERUM006',N'"BỘ DƯỠNG DA GENIFIQUE 03ML','sr006.jpg','19/10/2003','19','SERUM_A','Lacome',N'Bộ',1699000),
('SERUM011',N'"DƯỠNG CHẤT (SERUM) TRẺ HÓA DA ADVANCED GENSIFIQUE','sr011.jpg','24/05/2003','03','SERUM_B','Lacome',N'Chai',1119000),
('SERUM012',N'"DƯỠNG CHẤT GIẢM THÂM MỤN, ĐỐM NÂU CLARIFIQUE','sr012.jpg','21/03/2003','03','SERUM_B','Lacome',N'Chai',1129000),
('SERUM013',N'"SERUM TƯƠI 3 LÕI RÉNERGIE H.C.F TRIPLE','sr013.jpg','13/07/2003','03','SERUM_B','Lacome',N'Chai',1139000),
('SERUM014',N'"DƯỠNG CHẤT VÙNG DA MẮT VÀ MI ADVANCED GÉNIFIQUE YEUX LIGHT','sr014.jpg','03/08/2003','12','SERUM_B','Lacome',N'Chai',1149000),
('SERUM015',N'"DƯỠNG CHẤT TÁI TẠO TẾ BÀO CHUYÊN SÂU ABSOLUE','sr015.jpg','28/09/2003','03','SERUM_B','Lacome',N'Chai',1159000),
('SERUM016',N'"DƯỠNG CHẤT AMPOULE ABSOLUE GIÚP NGĂN NGỪA LÃO HÓA DA TỐI ƯU','sr016.jpg','27/10/2003','03','SERUM_B','Lacome',N'Chai',1169000),

('CREAM001',N'KEM DƯỠNG DA NGĂN NGỪA DẤU HIỆU LÃO HÓA & GIẢM ĐỐM NÂU','cr001.jpg','01/01/2014','02','CREAM_A','Lacome',N'Lọ',1199000),
('CREAM002',N'KEM DƯỠNG DA CLARIFIQUE','cr002.jpg','04/02/2003','02','CREAM_A','Lacome',N'Lọ',1299000),
('CREAM003',N'KEM DƯỠNG GIÚP TÁI TẠO LÀN DA ABSOLUE SOFT CREAM','cr003.jpg','02/04/2014','02','CREAM_A','Lacome',N'Lọ',1399000),
('CREAM011',N'KEM DƯỠNG MẮT CHIẾT XUẤT TỪ TẾ BÀO GỐC HOA HỒNG ABSOLUE L EXTRAIT','cr011.jpg','05/04/2003','02','CREAM_B','Lacome',N'Lọ',1119000),
('CREAM012',N'KEM DƯỠNG MẮT RÉNERGIE','cr012.jpg','07/02/2016','02','CREAM_B','Lacome',N'Lọ',1129000),
('CREAM013',N'KEM DƯỠNG MẮT ADVANCED GENSIFIQUE YEUX','cr013.jpg','08/12/2003','02','CREAM_B','Lacome',N'Lọ',1139000),
('CREAM111',N'KEM CHỐNG NẮNG UV EXPERT AQUA GEL','cr111.jpg','04/12/2003','02','CREAM_C','Lacome',N'Tuýp',1119000),
('CREAM112',N'KEM CHỐNG NẮNG & NÂNG TÔNG DA UV EXPERT TONE UP SPF03 30ML','cr222.jpg','03/03/2016','02','CREAM_C','Lacome',N'Tuýp',1229000),
('CREAM113',N'KEM CHỐNG NẮNG CÓ MÀU UV EXPERT BBX3010 SPF0305','cr333.jpg','14/04/2003','02','CREAM_C','Lacome',N'Tuýp',1339000),

('NH001',N'NƯỚC HOA IDOLE EDP','nh001.jpg','01/01/2014','03','PERFUME','Lacome',N'Lọ',1199000),
('NH002',N'NƯỚC HOA LAVIE EST BELLE','nh002.jpg','02/02/2014','03','PERFUME','Lacome',N'Lọ',1299000),
('NH003',N'NƯỚC HOA LA NUIT TRÉSOR FLEUR DE NUIT’S QUYẾN RŨ, LÔI CUỐN','nh003.jpg','03/03/2014','03','PERFUME','Lacome',N'Lọ',1399000),
('SON001',N'SON MÔI MỊN LÌ L ABSOLU ROUGE INTIMATTE','son001.jpg','01/01/2014','03','MAKEUP','Lacome',N'Tuýp',1199000),
('SON002',N'SON MÔI LABSOLU ROUGE DRAMA MATTE','son002.jpg','02/02/2014','03','MAKEUP','Lacome',N'Tuýp',1299000),
('SON003',N'SON KEM BÁN LÌ LÂU TRÔI','son003.jpg','03/03/2014','03','MAKEUP','Lacome',N'Tuýp',1399000),
('TC001',N'LÕI THAY THẾ KEM DƯỠNG CHUYÊN SÂU TÁI TẠO LÀN DA ABSOLUE RICH','tc001.jpg','01/01/2014','03','ABSOLUE','Lacome',N'Miếng',1199000),
('TC002',N'TINH CHẤT DƯỠNG MẮT ABSOLUE','tc002.jpg','02/02/2014','03','ABSOLUE','Lacome',N'Lọ',1299000),
('TC003',N'BỘ SẢN PHẨM CHĂM SÓC DA CAO CẤP ABSOLUE','tc003.jpg','03/03/2014','03','ABSOLUE','Lacome',N'Bộ',1399000);


INSERT INTO KHACHHANG
VALUES
('KH001',N'Nguyễn Thu Tâm',N'Tây Ninh','0989751723'),
('KH002',N'Đinh Bảo Lộc',N'Lâm Đồng','0918234654'),
('KH003',N'Trần Thanh Diệu',N'TP.HCM','0978123765'),
('KH004',N'Hồ Tuấn Thành',N'Hà Nội','0909456768'),
('KH005',N'Huỳnh Kim Ánh',N'Khánh Hòa','0932987567')


INSERT INTO HOADON
VALUES 
('HD001','02/04/2003','KH001',21000000),
('HD002','03/05/2016','KH005',12000000),
('HD003','14/03/2016','KH004',3000000),
('HD004','03/03/2016','KH005',2300000),
('HD005','05/03/2016','KH001',1403000),
('HD006','07/07/2016','KH003',40300000),
('HD007','13/08/2016','KH002',1340300)


INSERT INTO CHITIETHD
VALUES
('HD001','CLEAN001','2',1000000,2000000),
('HD002','CLEAN002','1',2000000,2000000),
('HD003','CLEAN003','6',3000000,18000000),
('HD004','SERUM001','5',1030000,2030000),
('HD005','SERUM002','6',560000,3360000),
('HD003','SERUM003','3',400000,1200000),
('HD003','CREAM001','1',200000,200000),
('HD007','CREAM002','1',030000,030000),
('HD007','CREAM003','2',160000,320000),
('HD007','CLEAN001','1',1000000,1000000)

select TENMP,ANH,GIA from MYPHAM, LOAIMP where LOAIMP.MALOAI = MYPHAM.MALOAI AND MYPHAM.MALOAI='CLEAN_A';


SELECT * FROM LOAIMP
SELECT * FROM MYPHAM
SELECT * FROM KHACHHANG
SELECT * FROM HOADON
SELECT * FROM CHITIETHD


                                
create procedure UpdateGioHang @Mamp NCHAR(10),@TenDN VARCHAR(20)
as
	begin
		update GioHang 
		set GIA=(select GIA from MYPHAM where MYPHAM.MAMP=GioHang.MAMP),
		Anh=(select Anh from MYPHAM where MYPHAM.MAMP=GioHang.MAMP),
		TENMP=(select TENMP from MYPHAM where MYPHAM.MAMP=GioHang.MAMP),
		THANHTIEN=(select GIA*SoLuong from MYPHAM where MYPHAM.MAMP=GioHang.MAMP )
		where TENDN=@TenDN and MAMP=@Mamp
	end;
go

create procedure TangSoLuong @Mamp NCHAR(10),@TenDN VARCHAR(20)
as
	begin
		update GioHang 
		set SoLuong =SoLuong+1
		where TENDN=@TenDN and MAMP=@Mamp
	end;
go
--them vao gio hang
create procedure ThemGioHang @Mamp NCHAR(10),@TenDN VARCHAR(20)
as
	begin
		if EXISTS (select * from GioHang where MAMP=@Mamp and TENDN=@TenDN)
			begin
				exec TangSoLuong @Mamp,@TenDN;
				exec UpdateGioHang @Mamp,@TenDN
			end;
		else
			begin
				insert into GioHang(TenDN,MAMP,SoLuong) values(@TenDN,@Mamp,1);
				exec UpdateGioHang @Mamp,@TenDN
			end;
	end;
go
create proc UpdateSoLuong @Masp VARCHAR(20),@TenDN VARCHAR(20),@SoLuong int
as
	begin
		if @SoLuong <= 0
			delete from GioHang where TENDN=@TenDN and MAMP=@Masp
		else
			begin 
				update GioHang 
				set SoLuong =@SoLuong
				where TENDN=@TenDN and MAMP=@Masp
				exec UpdateGioHang @Masp,@TenDN
			end;
	end;
go

select * from GioHang
